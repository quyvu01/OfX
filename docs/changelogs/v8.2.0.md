# Changelog v8.2.0

All notable changes in this release.

## [8.2.0] - 2026-01-18

### Added

#### Result Pattern
- Added `Result` class for functional error handling without exceptions
- Added `Fault` class to encapsulate error information (Message, Code, Exception)
- Integrated Result pattern across all transport implementations

#### Supervisor Pattern
- Added `SupervisorOptions` for configuring supervisor behavior
- Added `SupervisionStrategy` enum with strategies:
  - `OneForOne` - Only restart the failed server
  - `OneForAll` - Restart all servers when one fails
  - `RestForOne` - Restart failed server and all servers registered after it
- Added `SupervisorDirective` enum with directives:
  - `Resume` - Ignore the failure and continue
  - `Restart` - Restart the server from a clean state
  - `Stop` - Stop the server permanently
  - `Escalate` - Escalate to parent supervisor
- Added `ServerHealth` enum for health state tracking
- Added `ServerSupervisor` base implementation with:
  - Exponential backoff (1s initial, 5m max, 2.0 multiplier)
  - Restart limits (default: 10 restarts per minute)
  - Circuit breaker support
  - Exception-to-directive mapping
- Added `IServerSupervisor` interface
- Added `ConfigureSupervisor()` method to `OfXRegister`
- Added supervisor workers for all message-based transports:
  - `NatsSupervisorWorker`
  - `RabbitMqSupervisorWorker`
  - `KafkaSupervisorWorker`
  - `AzureServiceBusSupervisorWorker`

#### Transport Abstractions
- Added `IRequestServer` interface for standardizing transport server implementations
- Updated all transport servers to implement `IRequestServer`:
  - `INatsServer<TModel, TAttribute>` extends `IRequestServer`
  - `IRabbitMqServer` extends `IRequestServer`
  - `IKafkaServer<TModel, TAttribute>` extends `IRequestServer`
  - `IAzureServiceBusServer<TModel, TAttribute>` extends `IRequestServer`

### Changed

#### Response Classes (Breaking)
- Renamed `OfXDataResponse` to `DataResponse`
- Renamed `OfXValueResponse` to `ValueResponse`

#### Exception Handling
- Exception information now passed through `Result<T>.Fault` instead of message headers
- Improved exception propagation in distributed scenarios

#### Configuration
- `SupervisorOptions` stored globally in `OfXStatics`
- Supervisor configuration applies to message-based transports only (NATS, RabbitMQ, Kafka, Azure Service Bus)
- gRPC transport excluded from supervisor pattern (uses HTTP/2 built-in recovery)

### Removed

- Removed `OfXConstants` class
- Removed header-based exception passing in favor of `Fault` class

### Files Changed

#### Core (OfX)
- `src/OfX/Responses/Result.cs` - New
- `src/OfX/Responses/Fault.cs` - New
- `src/OfX/Responses/DataResponse.cs` - Renamed from OfXDataResponse
- `src/OfX/Responses/ValueResponse.cs` - Renamed from OfXValueResponse
- `src/OfX/Abstractions/Transporting/IRequestServer.cs` - New
- `src/OfX/Supervision/SupervisorOptions.cs` - New
- `src/OfX/Supervision/SupervisionStrategy.cs` - New
- `src/OfX/Supervision/SupervisorDirective.cs` - New
- `src/OfX/Supervision/ServerHealth.cs` - New
- `src/OfX/Supervision/ServerSupervisor.cs` - New
- `src/OfX/Supervision/SupervisedServerState.cs` - New
- `src/OfX/Supervision/IServerSupervisor.cs` - New
- `src/OfX/Registries/OfXRegister.cs` - Added ConfigureSupervisor method
- `src/OfX/Statics/OfXStatics.cs` - Added SupervisorOptions property
- `src/OfX/Constants/OfXConstants.cs` - Removed

#### NATS (OfX.Nats)
- `src/OfX.Nats/Abstractions/INatsServer.cs` - Extends IRequestServer
- `src/OfX.Nats/BackgroundServices/NatsSupervisorWorker.cs` - New
- `src/OfX.Nats/BackgroundServices/NatsServerWorker.cs` - Removed
- `src/OfX.Nats/Extensions/NatsExtensions.cs` - Updated for supervisor
- `src/OfX.Nats/Implementations/NatsServer.cs` - Implements IRequestServer

#### RabbitMQ (OfX.RabbitMq)
- `src/OfX.RabbitMq/Abstractions/IRabbitMqServer.cs` - Extends IRequestServer
- `src/OfX.RabbitMq/BackgroundServices/RabbitMqSupervisorWorker.cs` - New
- `src/OfX.RabbitMq/BackgroundServices/RabbitMqServerHostedService.cs` - Removed
- `src/OfX.RabbitMq/Extensions/RabbitMqExtensions.cs` - Updated for supervisor

#### Kafka (OfX.Kafka)
- `src/OfX.Kafka/Abstractions/IKafkaServer.cs` - Extends IRequestServer
- `src/OfX.Kafka/BackgroundServices/KafkaSupervisorWorker.cs` - New
- `src/OfX.Kafka/BackgroundServices/KafkaServerWorker.cs` - Removed
- `src/OfX.Kafka/Extensions/KafkaExtensions.cs` - Updated for supervisor

#### Azure Service Bus (OfX.Azure.ServiceBus)
- `src/OfX.Azure.ServiceBus/Abstractions/IAzureServiceBusServer.cs` - Extends IRequestServer
- `src/OfX.Azure.ServiceBus/BackgroundServices/AzureServiceBusSupervisorWorker.cs` - New
- `src/OfX.Azure.ServiceBus/BackgroundServices/AzureServiceBusServerWorker.cs` - Removed
- `src/OfX.Azure.ServiceBus/Extensions/AzureServiceBusExtensions.cs` - Updated for supervisor

#### gRPC (OfX.Grpc)
- `src/OfX.Grpc/Implementations/GrpcServer.cs` - Updated for Result pattern
- `src/OfX.Grpc/Implementations/GrpcRequestClient.cs` - Updated for Result pattern

#### Entity Framework Core (OfX.EntityFrameworkCore)
- `src/OfX.EntityFrameworkCore/EfQueryHandler.cs` - Updated response types

#### MongoDB (OfX.MongoDb)
- `src/OfX.MongoDb/MongoDbQueryHandler.cs` - Updated response types

---

## Migration Steps

### 1. Update Response Types

Find and replace in your codebase:

```
OfXDataResponse -> DataResponse
OfXValueResponse -> ValueResponse
```

### 2. Update Using Statements

```csharp
// Add if using Result pattern
using OfX.Responses;
```

### 3. Remove OfXConstants References

If you were using `OfXConstants`, remove those references. Exception handling is now automatic through the Result pattern.

### 4. Configure Supervisor (Optional)

```csharp
services.AddOfX(cfg =>
{
    cfg.ConfigureSupervisor(opts =>
    {
        opts.Strategy = SupervisionStrategy.OneForOne;
        opts.MaxRestarts = 10;
        opts.RestartWindow = TimeSpan.FromMinutes(1);
        opts.EnableCircuitBreaker = true;
        opts.CircuitBreakerThreshold = 5;
        opts.CircuitBreakerResetTime = TimeSpan.FromMinutes(1);
    });

    // Add your transport
    cfg.AddRabbitMq(c => c.Host("localhost", "/"));
});
```

---

## Commits

| Commit | Description |
|--------|-------------|
| `67f01a2` | Add Result Pattern for OfX |
| `54fc7ad` | Add Exception handling via Fault, remove OfXConstants, rename response classes |
| `ec8146f` | Add IRequestServer interface for transport abstraction |
| `ce81ad3` | Add Supervisor pattern for message-based transports |
| `3645e48` | Update to version 8.2.0 |
