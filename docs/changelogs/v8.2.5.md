# Changelog v8.0.25

All notable changes in this release.

## [8.0.25] - 2025-01-24

### Added

#### ðŸ”­ Comprehensive Observability and Telemetry Infrastructure

**Core Telemetry Components:**

- **OfXActivitySource Enhancements**
  - Added `StartDatabaseActivity<TAttribute>()` for database query tracing
  - Extended `SetDatabaseTags()` with `collection` and `operation` parameters
  - Database activities support EF Core and MongoDB integrations

- **OfXMetrics Enhancements**
  - Added `RecordDatabaseQuery()` for successful database operations
  - Added `RecordDatabaseError()` for failed database operations
  - Metrics include labels: `ofx.attribute`, `ofx.db_system`, `ofx.status`, `ofx.error_type`

- **OfXDiagnostics Enhancements**
  - Added `DatabaseQueryStart()` event with attribute, db system, and expression
  - Added `DatabaseQueryStop()` event with item count and duration
  - Added `DatabaseQueryError()` event with exception details

**Database Integrations:**

- **Entity Framework Core (`OfX.EntityFrameworkCore`)**
  - Full distributed tracing with `StartDatabaseActivity`
  - Semantic tags: `db.system="efcore"`, `db.name`, `collection`, `operation`
  - Query duration metrics and error tracking
  - DiagnosticSource events for query lifecycle
  - Updated `IDbContextResolver<TModel>` interface with `DbContext` property
  - Modified `DbContextResolverInternal<TModel>` to expose DbContext

- **MongoDB (`OfX.MongoDb`)**
  - Full distributed tracing with `StartDatabaseActivity`
  - Semantic tags: `db.system="mongodb"`, `db.name`, `db.mongodb.collection`, `operation`
  - Query duration metrics and error tracking
  - DiagnosticSource events for query lifecycle

**Message Transport Integrations:**

- **RabbitMQ (`OfX.RabbitMq`)**
  - Client-side: W3C Trace Context propagation via RabbitMQ headers (`traceparent`, `tracestate`)
  - Server-side: Parent context extraction and activity linking
  - Messaging semantic tags: `messaging.system`, `messaging.destination`, `messaging.message_id`
  - Request/response metrics with duration and item count
  - Active request gauge monitoring
  - Modified files:
    - `RabbitMqRequestClient.cs` - Added client-side telemetry
    - `RabbitMqServer.cs` - Added server-side telemetry

- **Kafka (`OfX.Kafka`)**
  - Client-side: W3C Trace Context propagation via Kafka message headers
  - Server-side: Parent context extraction from Kafka headers
  - Messaging semantic tags following OpenTelemetry conventions
  - Request/response duration histograms
  - Error rate tracking by error type
  - Modified files:
    - `KafkaClient.cs` - Added client-side telemetry
    - `KafkaServer.cs` - Added server-side telemetry

- **Azure Service Bus (`OfX.Azure.ServiceBus`)**
  - Client-side: W3C Trace Context propagation via ApplicationProperties
  - Server-side: Parent context extraction from message properties
  - Session-based message correlation support
  - Messaging semantic tags and OfX-specific tags
  - Comprehensive error tracking and metrics
  - Modified files:
    - `OpenAzureServiceBusClient.cs` - Added client-side telemetry
    - `AzureServiceBusServer.cs` - Added server-side telemetry

- **gRPC (`OfX.Grpc`)**
  - Client-side: Distributed tracing with automatic trace propagation by gRPC
  - Server-side: Parent context extraction from gRPC metadata
  - RPC semantic tags and operation tracking
  - Request/response metrics with item count tracking
  - Timeout and error handling with proper status codes
  - Modified files:
    - `GrpcRequestClient.cs` - Added client-side telemetry
    - `GrpcServer.cs` - Added server-side telemetry

#### OpenTelemetry Integration Features

**W3C Trace Context Propagation:**
- Automatic trace context propagation across all message transports
- `traceparent` and `tracestate` headers maintained through distributed calls
- Parent-child activity relationships preserved in async processing
- Cross-service trace correlation

**OpenTelemetry Semantic Conventions:**
- Messaging attributes: `messaging.system`, `messaging.destination`, `messaging.operation`, `messaging.message_id`
- Database attributes: `db.system`, `db.name`, `db.operation`, `db.mongodb.collection`
- OfX-specific attributes: `ofx.attribute`, `ofx.transport`, `ofx.expression`, `ofx.selector_ids`, `ofx.item_count`, `ofx.version`

**Metrics Collection:**
- Request duration histograms with multi-dimensional labels
- Item count tracking for data operations
- Active request gauges for concurrent monitoring
- Error counters categorized by error type

**DiagnosticSource Events:**
- Request lifecycle: `ofx.request.start`, `ofx.request.stop`, `ofx.request.error`
- Database lifecycle: `ofx.database.query.start`, `ofx.database.query.stop`, `ofx.database.query.error`
- Messaging events: `ofx.message.receive`, `ofx.message.send`

### Technical Implementation Details

**Telemetry Patterns:**

- **Client-Side Pattern:**
  ```csharp
  using var activity = OfXActivitySource.StartClientActivity<TAttribute>(TransportName);
  var stopwatch = Stopwatch.StartNew();
  // Propagate W3C trace context
  // SetMessagingTags, SetOfXTags
  // UpdateActiveRequests(1)
  // Execute request
  // RecordRequest or RecordError
  // UpdateActiveRequests(-1)
  ```

- **Server-Side Pattern:**
  ```csharp
  // Extract parent context from headers/metadata
  using var activity = OfXActivitySource.StartServerActivity(attributeName, parentContext);
  var stopwatch = Stopwatch.StartNew();
  // SetMessagingTags
  // Process message
  // RecordRequest or RecordError
  // SetStatus(Ok or Error)
  ```

- **Database Query Pattern:**
  ```csharp
  using var activity = OfXActivitySource.StartDatabaseActivity<TAttribute>(DbSystem);
  var stopwatch = Stopwatch.StartNew();
  // SetDatabaseTags
  // Execute query
  // RecordDatabaseQuery or RecordDatabaseError
  ```

**Error Handling:**
- Exception recording in activities via `RecordException()`
- Activity status codes (Ok/Error) for all operations
- Detailed error metrics with error type classification
- Proper error propagation with telemetry context

**Performance Considerations:**
- Minimal overhead with conditional activity creation
- Efficient metric recording using TagList structures
- Non-blocking diagnostic event emission
- Lazy initialization patterns where applicable

### Changed

- Enhanced all transport client and server implementations with telemetry
- Updated database query handlers with distributed tracing support
- Improved error handling across all integrations with telemetry context

### Infrastructure

- **Backward Compatibility:** All changes are fully backward compatible
- **Zero Breaking Changes:** No API changes, all existing code continues to work
- **Opt-in Telemetry:** Telemetry features activated only via OpenTelemetry configuration
- **Standard Integration:** Compatible with Jaeger, Prometheus, Grafana, and other OTLP backends

---

## Files Changed

| Component | Files Modified |
|-----------|----------------|
| **Core Telemetry** | `OfX/Telemetry/OfXActivitySource.cs`, `OfX/Telemetry/OfXMetrics.cs`, `OfX/Telemetry/OfXDiagnostics.cs`, `OfX/Statics/Constants.cs` |
| **EF Core** | `OfX.EntityFrameworkCore/EfQueryHandler.cs`, `OfX.EntityFrameworkCore/Abstractions/IDbContextResolver.cs`, `OfX.EntityFrameworkCore/Implementations/DbContextResolverInternal.cs` |
| **MongoDB** | `OfX.MongoDb/MongoDbQueryHandler.cs` |
| **RabbitMQ** | `OfX.RabbitMq/Implementations/RabbitMqRequestClient.cs`, `OfX.RabbitMq/Implementations/RabbitMqServer.cs` |
| **Kafka** | `OfX.Kafka/Implementations/KafkaClient.cs`, `OfX.Kafka/Implementations/KafkaServer.cs` |
| **Azure Service Bus** | `OfX.Azure.ServiceBus/Implementations/OpenAzureServiceBusClient.cs`, `OfX.Azure.ServiceBus/Implementations/AzureServiceBusServer.cs` |
| **gRPC** | `OfX.Grpc/Implementations/GrpcRequestClient.cs`, `OfX.Grpc/Implementations/GrpcServer.cs`, `OfX.Grpc/Extensions/GrpcExtensions.cs` |

---

## Commits

| Commit | Description |
|--------|-------------|
| `df19cc6` | Add all observability to: NATS, RabbitMQ, Kafka, AzureServiceBus, gRPC. Upgrade version to 8.0.25 |
| `8208f9d` | Add observer for EfCore and MongoDb |

---

## Observability Stack Integration

OfX 8.0.25 integrates seamlessly with:

- **Jaeger** - Distributed tracing visualization
- **Prometheus** - Metrics collection and alerting
- **Grafana** - Dashboards and visualization
- **OpenTelemetry Collector** - Telemetry aggregation
- **Application Insights** - Azure monitoring
- **Datadog, New Relic, Honeycomb** - Third-party APM solutions

---

## Migration Notes

**From v8.2.4 to v8.0.25:**

- **Zero breaking changes**
- **No code modifications required**
- **Telemetry is opt-in** via OpenTelemetry configuration
- **All existing functionality preserved**

Simply update the package and optionally configure OpenTelemetry to enable telemetry features.
