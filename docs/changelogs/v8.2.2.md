# Changelog v8.2.2

All notable changes in this release.

## [8.2.2] - 2026-01-18

### Fixed

#### EF Core Concurrent Issue
- Fixed critical bug where concurrent requests could share the same DbContext instance
- `EfQueryHandler` now creates a new `IServiceScope` per request
- Each request gets its own isolated DbContext instance
- Prevents `InvalidOperationException` from concurrent DbContext access

### Changed

#### EfQueryHandler Scope Management
- Added `using var scope = serviceProvider.CreateScope()` pattern
- DbContext is now resolved from the scoped service provider
- Scope is properly disposed after request completion

---

## Files Changed

### Modified Files

| File | Changes |
|------|---------|
| `src/OfX.EntityFrameworkCore/EfQueryHandler.cs` | Added scope creation per request for DbContext isolation |

---

## Code Changes

### EfQueryHandler.cs (Modified)

```csharp
// Before: Shared DbContext (bug)
public async Task<OfXDataResponse[]> HandleAsync(...)
{
    var dbContext = _serviceProvider.GetRequiredService<TDbContext>();
    // Risk: concurrent requests share the same DbContext
    ...
}

// After: Scoped DbContext (fix)
public async Task<OfXDataResponse[]> HandleAsync(...)
{
    using var scope = _serviceProvider.CreateScope();
    var dbContext = scope.ServiceProvider.GetRequiredService<TDbContext>();
    // Safe: each request has its own DbContext
    ...
}
```

---

## Why This Matters

### The Problem

EF Core's DbContext is **not thread-safe**. When multiple requests run concurrently:

```
Request 1 ──────[Start Query]──────[Processing]──────[End]
Request 2 ──────────[Start Query]──────[ERROR!]
                     ↑
                     Shared DbContext = InvalidOperationException
```

### The Solution

With scoped DbContext:

```
Request 1 ──────[Scope 1]──[DbContext 1]──[Query]──[Dispose]
Request 2 ──────[Scope 2]──[DbContext 2]──[Query]──[Dispose]
                     ↑
                     Isolated = No conflicts
```

---

## Symptoms Fixed

If you experienced any of these errors, this fix resolves them:

- `InvalidOperationException: A second operation started on this context before a previous operation completed`
- `ObjectDisposedException: Cannot access a disposed context instance`
- Intermittent query failures under load
- Race conditions in concurrent scenarios

---

## Commits

| Commit | Description |
|--------|-------------|
| `fd45b9f` | Fix bug EFCore concurrent issue by DbContext! |
| `a7450b3` | Update EfQueryHandler => Always using new Scope to prevent Concurrent issue? |
