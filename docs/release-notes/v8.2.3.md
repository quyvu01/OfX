# OfX v8.2.3 Release Notes

**Release Date:** January 19, 2026

## Overview

OfX v8.2.3 introduces two significant enhancements: **attribute validation for duplicate entity configurations** and a **new indexer format** for ordering collections without pagination.

---

## Highlights

### Attribute Validation for Duplicate Entities

OfX now validates that each `OfXAttribute` type is only configured for a single entity. Attempting to use the same attribute for multiple entities will throw a clear exception at startup.

**Example of Invalid Configuration:**

```csharp
// This will throw OfXException at startup
[OfXConfigFor<UserOfAttribute>(nameof(Id), nameof(Name))]
public class User { ... }

[OfXConfigFor<UserOfAttribute>(nameof(Id), nameof(Name))]  // ERROR!
public class Employee { ... }
```

**Exception Message:**
```
The attribute 'UserOfAttribute' is already configured for entity 'User'.
Cannot configure it for entity 'Employee'. Each OfXAttribute must only be
used with a single entity type.
```

### New Indexer Format: Order-Only `[asc/desc Property]`

Added support for a new indexer format that orders a collection without applying skip/take pagination.

**Supported Indexer Formats:**

| Format | Example | Description |
|--------|---------|-------------|
| `[asc Property]` | `Items[asc Name]` | Order only (no pagination) |
| `[0 asc Property]` | `Items[0 asc Name]` | First item after ordering |
| `[-1 desc Property]` | `Items[-1 desc Date]` | Last item after ordering |
| `[0 10 asc Property]` | `Items[0 10 asc Name]` | Skip 0, take 10 |

**Use Cases:**

```csharp
// Get all orders sorted by date (newest first)
"Orders[desc OrderDate]"

// Get all orders sorted by date, then project
"Orders[desc OrderDate].{Id, Status, Total}"

// Get all orders sorted by total (highest first), then count
"Orders[desc Total]:count"
```

---

## Technical Details

### Attribute Validation

The validation occurs during service registration when scanning assemblies for `OfXConfigFor` attributes:

1. Scans all types with `OfXConfigFor<TAttribute>` attribute
2. Groups by attribute type
3. Throws `OfXException` if any attribute is used by multiple entities

### IndexerNode Changes

The `IndexerNode` record now supports nullable `Skip` and `Take`:

```csharp
public sealed record IndexerNode(
    ExpressionNode Source,
    int? Skip,      // Nullable for order-only format
    int? Take,      // Nullable for single item or order-only
    OrderDirection OrderDirection,
    string OrderBy) : ExpressionNode
{
    public bool IsOrderOnly => Skip is null && Take is null;
    public bool IsSingleItem => Skip is not null && Take is null;
    public bool IsLastItem => IsSingleItem && Skip < 0;
}
```

### Parser Grammar Update

```
Indexer := '[' (Number (Number)?)? ('asc' | 'desc') Identifier ']'
```

The number tokens are now optional, allowing formats like `[asc Name]`.

---

## Files Changed

### Core Changes

| File | Description |
|------|-------------|
| `src/OfX/Expressions/Nodes/IndexerNode.cs` | Added nullable Skip/Take, IsOrderOnly property |
| `src/OfX/Expressions/Parsing/ExpressionParser.cs` | Updated parser for order-only format |
| `src/OfX/Expressions/Building/LinqExpressionBuilder.cs` | Added handling for IsOrderOnly case |
| `src/OfX/Statics/OfXStatics.cs` | Added duplicate attribute validation |
| `src/OfX/Exceptions/OfXException.cs` | Added DuplicateAttributeConfiguration exception |

### Test Changes

| File | Description |
|------|-------------|
| `test/OfX.Tests/UnitTests/Expressions/ExpressionParserTests.cs` | Added tests for order-only format |
| `test/OfX.Tests/IntegrationTests/Expressions/ExpressionIntegrationTests.cs` | Comprehensive integration tests |
| `test/OfX.Tests/UnitTests/Exceptions/OfXExceptionTests.cs` | Added duplicate attribute validation tests |

---

## Upgrade Guide

This is a **non-breaking** patch release for most users. However, if you have:

1. **Duplicate attribute configurations** - You will get a startup exception. Fix by using separate attribute types for each entity.

2. **Custom expression parsing** - No changes needed; the new format is additive.

Update the NuGet package:

```bash
dotnet add package OfX --version 8.2.3
```

---

## Links

- [Full Changelog](../changelogs/v8.2.3.md)
- [Expression Documentation](../expression.md)
- [GitHub Repository](https://github.com/quyvu/OfX)
