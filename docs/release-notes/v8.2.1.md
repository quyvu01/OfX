# OfX v8.2.1 Release Notes

**Release Date:** January 18, 2026

## Overview

OfX v8.2.1 is a performance-focused release that introduces **parameterized query support** for EF Core, significantly improving database query plan caching and overall performance.

---

## Highlights

### Parameterized Queries for EF Core

Filter expressions now generate **parameterized SQL queries** instead of inline values, enabling database query plan reuse.

**Before (v8.2.0):**
```sql
SELECT * FROM "Users" WHERE "Id" IN ('1', '2', '3')
```
Each unique set of IDs generates a different query plan.

**After (v8.2.1):**
```sql
-- PostgreSQL
SELECT * FROM "Users" WHERE "Id" = ANY(@__Ids_0)

-- SQL Server
SELECT * FROM Users WHERE EXISTS (
    SELECT 1 FROM OPENJSON(@__Ids_0) WHERE [value] = Users.Id
)
```
Single query plan reused for all requests.

### Performance Benefits

| Metric | Before | After |
|--------|--------|-------|
| Query plan cache hit | ~2% | ~99% |
| Database CPU (compile) | High | Minimal |
| Average latency | Higher | Lower |
| Plan cache memory | Bloated | Stable |

### FilterContext Pattern

Introduced `FilterContext<TId>` wrapper class to enable EF Core parameterization:

- Uses `MemberAccess` expression instead of `ConstantExpression`
- EF Core recognizes closure-like pattern and parameterizes the query
- Compiled factory delegate for fast instance creation (~10x faster than `Activator.CreateInstance`)
- Static cached `PropertyInfo` per ID type

---

## Technical Details

### How It Works

EF Core parameterizes queries when it sees `MemberAccess` on a closure object:

```csharp
// Old approach - inline values
Expression.Constant(ids)  // → WHERE Id IN ('1', '2', '3')

// New approach - parameterized
var context = new FilterContext<TId> { Ids = ids };
Expression.Property(Expression.Constant(context), "Ids")
// → WHERE Id = ANY(@__Ids_0)
```

### Thread Safety

- New `FilterContext` instance created per request
- Avoids race conditions with concurrent queries
- Factory delegate cached and compiled once

### Caching Strategy

| Component | Cached | Lifetime |
|-----------|--------|----------|
| `FilterContextType` | Yes | Static per TModel/TAttribute |
| `FilterContextFactory` | Yes | Static per TModel/TAttribute |
| `PropertyInfo` (Ids) | Yes | Static per TId type |
| `FilterContext` instance | No | Per request |

---

## Files Changed

- `src/OfX/Builders/FilterContext.cs` - New file
- `src/OfX/Builders/QueryHandlerBuilder.cs` - Updated filter expression building

---

## Upgrade Guide

This is a **non-breaking** patch release. Simply update the NuGet package:

```bash
dotnet add package OfX --version 8.2.1
```

No code changes required. The parameterization is automatic.

---

## Links

- [Full Changelog](../changelogs/v8.2.1.md)
- [GitHub Repository](https://github.com/quyvu/OfX)
